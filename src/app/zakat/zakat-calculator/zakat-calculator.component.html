<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="card card-custom">
      <div class="card-header-custom d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h4 mb-0" style="color: #0F5132;"><i class="fas fa-hand-holding-heart me-2 text-warning"></i>Ma Zakat</h2>
        </div>
        <div *ngIf="auth.user$ | async">
          <button class="btn btn-sm btn-outline-danger rounded-circle" (click)="auth.logout()" title="Déconnexion">
            <i class="fas fa-power-off"></i>
          </button>
        </div>
      </div>

      <div class="card-body p-4 p-lg-5">
        
        <div *ngIf="isLoading" class="text-center py-5 text-muted">
          <div class="spinner-border text-success mb-3" role="status"></div>
          <div>Chargement des taux...</div>
        </div>

        <div *ngIf="!isLoading">
          <div class="d-flex align-items-center justify-content-between p-4 mb-5 rounded-4 text-white" 
               style="background: linear-gradient(135deg, #0F5132 0%, #0b3d26 100%); position: relative; overflow: hidden;">
            <i class="fas fa-kaaba position-absolute text-white opacity-25" style="font-size: 10rem; right: -20px; top: -20px;"></i>
            
            <div class="position-relative z-1">
              <span class="text-warning text-uppercase small fw-bold ls-1">Seuil du Nissab (Aujourd'hui)</span>
              <div class="display-5 fw-bold font-monospace">{{ dailyValues?.nissabZakat | number:'1.0-0' }} <span class="fs-4">DT</span></div>
            </div>
            <div class="text-end position-relative z-1 d-none d-sm-block">
              <div class="badge bg-warning text-dark mb-1">Or 24k</div>
              <div class="fw-bold">{{ dailyValues?.goldPrice }} DT/g</div>
            </div>
          </div>

          <form [formGroup]="zakatForm" class="row g-4">
            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold text-uppercase">Épargne & Cash</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-wallet"></i></span>
                <input type="number" formControlName="epargne" class="form-control" placeholder="0">
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold text-uppercase">Or (Grammes)</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-ring"></i></span>
                <input type="number" formControlName="or_grammes" class="form-control" placeholder="0">
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold text-uppercase">Argent Prêté</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-hand-holding-usd"></i></span>
                <input type="number" formControlName="argent_prete" class="form-control" placeholder="0">
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label text-danger small fw-bold text-uppercase">Dettes à déduire</label>
              <div class="input-group">
                <span class="input-group-text text-danger border-danger"><i class="fas fa-file-invoice-dollar"></i></span>
                <input type="number" formControlName="dettes" class="form-control border-danger text-danger" placeholder="0">
              </div>
            </div>
          </form>

          <hr class="my-5 opacity-10">

          <div class="text-center">
            <div *ngIf="isEligible" class="animate-bounce">
              <div class="d-inline-block p-4 rounded-circle bg-success text-white shadow mb-3" style="width: 80px; height: 80px; display: grid; place-items: center;">
                <i class="fas fa-check fa-2x"></i>
              </div>
              <h3 class="text-success mb-0">Zakat Due</h3>
              <h1 class="display-3 fw-bold text-dark mb-2">{{ zakatAmount | number:'1.3-3' }} <span class="fs-4 text-muted">DT</span></h1>
              <p class="text-muted">Macha Allah, purifiez vos biens.</p>
            </div>

            <div *ngIf="!isEligible" class="opacity-75">
              <div class="d-inline-block p-3 rounded-circle bg-light text-muted mb-3">
                <i class="fas fa-minus fa-2x"></i>
              </div>
              <h4 class="text-muted">Non Imposable</h4>
              <p class="small text-muted">Votre net est inférieur au Nissab.</p>
            </div>

            <div class="mt-4 pt-3 border-top" *ngIf="isEligible">
               <ng-container *ngIf="auth.user$ | async as user; else loginBtn">
                  <button class="btn btn-emerald w-100 py-3" (click)="sauvegarderResultat(user)">
                    <i class="fas fa-save me-2"></i> Enregistrer le calcul
                  </button>
               </ng-container>
               <ng-template #loginBtn>
                  <a routerLink="/login" class="btn btn-gold-outline w-100">Se connecter pour sauvegarder</a>
               </ng-template>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
